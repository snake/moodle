{"version":3,"sources":["../src/chooser_dialogue.js"],"names":["carouselPageTo","e","mappedModules","modal","carousel","module","target","closest","selectors","regions","chooserOption","container","moduleName","dataset","modname","Templates","renderForPromise","get","html","js","help","getBody","querySelector","replaceNodeContents","helpContent","chooserSummary","content","focus","registerListenerEvents","addEventListener","actions","optionActions","showSummary","matches","closeOption","initKeyboardNavigation","chooserOptions","document","querySelectorAll","Array","from","forEach","element","keyCode","arrowRight","arrowLeft","currentOption","nextOption","nextElementSibling","clickErrorHandler","previousOption","previousElementSibling","home","firstOption","firstElementChild","end","lastOption","lastElementChild","item","displayChooser","data","origin","sectionid","Promise","ModalFactory","types","DEFAULT","render","type","title","body","large","create","all","Map","allmodules","set","modulename","getRoot","on","ModalEvents","bodyRendered","modalWrap","region","classList","add","hidden","destroy","show"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * A type of dialogue used as for choosing options.\n *\n * @module     core_course/chooser_dialogue\n * @package    core\n * @copyright  2019 Mihail Geshoski <mihail@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.9\n */\n\nimport $ from 'jquery';\nimport * as ModalEvents from 'core/modal_events';\nimport selectors from 'core_course/local/chooser/selectors';\nimport * as ModalFactory from 'core/modal_factory';\nimport * as Templates from 'core/templates';\nimport {get_string as getString} from 'core/str';\nimport {end, arrowLeft, arrowRight, home} from 'core/key_codes';\n\n/**\n * Given an event from the main module 'page' navigate to it's help section via a carousel.\n *\n * @method carouselPageTo\n * @param {EventFacade} e Triggering Event\n * @param {Map} mappedModules A map of all of the modules we are working with with K: mod_name V: {Object}\n * @param {Promise} modal Our modal that we are working with\n * @param {jQuery} carousel Our initialized carousel to manipulate\n */\nconst carouselPageTo = async(e, mappedModules, modal, carousel) => {\n    // Get the systems name for the module just clicked.\n    const module = e.target.closest(selectors.regions.chooserOption.container);\n    const moduleName = module.dataset.modname;\n    // Build up the html & js ready to place into the help section.\n    const {html, js} = await Templates.renderForPromise('core_course/chooser_help', mappedModules.get(moduleName));\n    const help = modal.getBody()[0].querySelector(selectors.regions.help);\n    await Templates.replaceNodeContents(help, html, js);\n    // Trigger the transition between 'pages'.\n    carousel.carousel('next');\n    carousel.carousel('pause');\n\n    const helpContent = help.querySelector(selectors.regions.chooserSummary.content);\n    helpContent.focus();\n};\n\n/**\n * Register chooser related event listeners.\n *\n * @method registerListenerEvents\n * @param {Promise} modal Our modal that we are working with\n * @param {Map} mappedModules A map of all of the modules we are working with with K: mod_name V: {Object}\n */\nconst registerListenerEvents = (modal, mappedModules) => {\n    modal.getBody()[0].addEventListener('click', async(e) => {\n        const carousel = $(selectors.regions.carousel);\n        carousel.carousel();\n        carousel.carousel('pause');\n        if (e.target.closest(selectors.actions.optionActions.showSummary)) {\n            await carouselPageTo(e, mappedModules, modal, carousel);\n        }\n        // From the help screen go back to the module overview.\n        if (e.target.matches(selectors.actions.closeOption)) {\n            // Trigger the transition between 'pages'.\n            carousel.carousel('prev');\n            carousel.carousel('dispose');\n        }\n    });\n\n    // Register event listeners related to the keyboard navigation controls.\n    initKeyboardNavigation(modal, mappedModules);\n};\n\n/**\n * Initialise the keyboard navigation controls for the chooser.\n *\n * @method initKeyboardNavigation\n * @param {Promise} modal Our modal that we are working with\n * @param {Map} mappedModules A map of all of the modules we are working with with K: mod_name V: {Object}\n */\nconst initKeyboardNavigation = (modal, mappedModules) => {\n\n    const chooserOptions = document.querySelectorAll(selectors.regions.chooserOption.container);\n\n    Array.from(chooserOptions).forEach((element) => {\n        return element.addEventListener('keyup', async(e) => {\n\n            // Check for left/ right triggers for showing the help.\n            if (e.keyCode === arrowRight || e.keyCode === arrowLeft) {\n                if (e.target.matches(selectors.actions.optionActions.showSummary)) {\n                    const carousel = $(selectors.regions.carousel);\n                    carousel.carousel();\n                    carousel.carousel('pause');\n                    await carouselPageTo(e, mappedModules, modal, carousel);\n                }\n            }\n\n            // Next.\n            if (e.keyCode === arrowRight) {\n                if (!e.target.matches(selectors.actions.optionActions.showSummary)) {\n                    const currentOption = e.target.closest(selectors.regions.chooserOption.container);\n                    const nextOption = currentOption.nextElementSibling;\n                    clickErrorHandler(nextOption);\n                }\n            }\n\n            // Previous.\n            if (e.keyCode === arrowLeft) {\n                if (!e.target.matches(selectors.actions.optionActions.showSummary)) {\n                    const currentOption = e.target.closest(selectors.regions.chooserOption.container);\n                    const previousOption = currentOption.previousElementSibling;\n                    clickErrorHandler(previousOption);\n                }\n            }\n\n            if (e.keyCode === home) {\n                const chooserOptions = document.querySelector(selectors.regions.chooserOptions);\n                const firstOption = chooserOptions.firstElementChild;\n                firstOption.focus();\n            }\n\n            if (e.keyCode === end) {\n                const chooserOptions = document.querySelector(selectors.regions.chooserOptions);\n                const lastOption = chooserOptions.lastElementChild;\n                lastOption.focus();\n            }\n        });\n    });\n};\n\n/**\n * Small error handling function to make sure the navigated to object exists\n *\n * @method clickErrorHandler\n * @param {HTMLElement} item What we want to check exists\n */\nconst clickErrorHandler = (item) => {\n    if (item !== null) {\n        item.focus();\n    }\n};\n\n/**\n * Display the module chooser.\n *\n * @method displayChooser\n * @param {EventFacade} e Triggering Event\n * @param {Object} data Object containing the data required by the chooser template\n */\nexport const displayChooser = async(e, data) => {\n    // Combine a class with the section id to avoid other sectionid data attributes.\n    const origin = document.querySelector(`.section-modchooser-text[data-sectionid=\"${e.target.dataset.sectionid}\"]`);\n\n    const [\n        modal,\n    ] = await Promise.all([\n        ModalFactory.create({\n            type: ModalFactory.types.DEFAULT,\n            title: await getString('addresourceoractivity'),\n            body: Templates.render('core_course/chooser', data),\n            large: true\n        })\n    ]);\n\n    // Make a map so we can quickly fetch a specific module's object for either rendering or searching.\n    const mappedModules = new Map();\n    data.allmodules.forEach((module) => {\n        mappedModules.set(module.modulename, module);\n    });\n\n    // Modal has rendered our initial content, we can allow users to interact.\n    modal.getRoot().on(ModalEvents.bodyRendered, (e) => {\n        // Region data attr used as ID fetching was patchy.\n        const modalWrap = document.querySelector(`[data-region=\"${e.target.dataset.region}\"]`);\n        modalWrap.classList.add('modchooser');\n\n        // Register event listeners.\n        registerListenerEvents(modal, mappedModules);\n    });\n\n    // We want to focus on the action select when the dialog is closed.\n    modal.getRoot().on(ModalEvents.hidden, () => {\n        modal.destroy();\n        try {\n            origin.closest('.section-modchooser-link').focus();\n        } catch (e) {\n            // eslint-disable-line\n        }\n    });\n\n    modal.show();\n};\n"],"file":"chooser_dialogue.min.js"}