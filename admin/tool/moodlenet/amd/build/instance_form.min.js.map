{"version":3,"sources":["../src/instance_form.js"],"names":["define","Validator","Selectors","LoadingIcon","Templates","Notification","$","registerListenerEvents","page","defaulturl","addEventListener","e","target","matches","action","browse","window","location","submit","input","querySelector","overlay","region","spinner","validationArea","document","classList","remove","addIconToContainerWithPromise","validation","then","result","resolve","add","innerText","message","setTimeout","catch","chooserNavigateToMnet","showMoodleNet","footerData","carousel","modal","innerHTML","spinnerPromise","addIconToContainer","transitionPromiseResolver","transitionPromise","Promise","when","render","html","js","replaceNodeContents","exception","generic","one","setFooter","chooserNavigateFromMnet","customfootertemplate","chooserFooterLogic","data","courseId","caller","enabled","courseID","sectionID","init","instancePage","footerDataBuilder","installed","footerClickListener","closest","preventDefault","getBody","find","moodleNet","closeOption"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Our basic form manager for when a user either enters\n * their profile url or just wants to browse.\n *\n * This file is a mishmash of JS functions we need for both the standalone (M3.7, M3.8)\n * plugin & Moodle 3.9 functions. The 3.9 Functions have a base understanding that certain\n * things exist i.e. directory structures for templates. When this feature goes 3.9+ only\n * The goal is that we can quickly gut all AMD modules into bare JS files and use ES6 guidelines.\n * Till then this will have to do.\n *\n * @module     tool_moodlenet/instance_form\n * @package    tool_moodlenet\n * @copyright  2020 Mathew May <mathew.solutions>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['tool_moodlenet/validator',\n        'tool_moodlenet/selectors',\n        'core/loadingicon',\n        'core/templates',\n        'core/notification',\n        'jquery'],\n    function(Validator,\n             Selectors,\n             LoadingIcon,\n             Templates,\n             Notification,\n             $) {\n    /**\n     * Set up the form.\n     *\n     * @method init\n     * @param {String} defaulturl Our base case / Moodle's own MoodleNet instance.\n     */\n    var init = function init(defaulturl) {\n        var page = document.querySelector(Selectors.region.instancePage);\n        registerListenerEvents(page, defaulturl);\n    };\n\n    /**\n     * Add the event listeners to our form.\n     *\n     * @method registerListenerEvents\n     * @param {HTMLElement} page The whole page element for our form area\n     * @param {String} defaulturl Our base case / Moodle's own MoodleNet instance.\n     */\n    var registerListenerEvents = function registerListenerEvents(page, defaulturl) {\n        page.addEventListener('click', function(e) {\n            // Browse without an account.\n            if (e.target.matches(Selectors.action.browse)) {\n                if (defaulturl) {}\n                var loc = \"https://moodlenet.prototype.moodledemo.net/testclient.php\"\n                    + \"?site=https%3A%2F%2Fmoodlenet.prototype.moodledemo.net\"\n                    + \"&path=admin%2Ftool%2Fmoodlenet%2Fimport.php%3Fcourse%3D2%26section%3D0\";\n                window.location = loc;\n            }\n\n            // Our fake submit button / browse button.\n            if (e.target.matches(Selectors.action.submit)) {\n                var input = page.querySelector('[data-var=\"mnet-link\"]');\n                var overlay = page.querySelector(Selectors.region.spinner);\n                var validationArea = document.querySelector(Selectors.region.validationArea);\n\n                overlay.classList.remove('d-none');\n                var spinner = LoadingIcon.addIconToContainerWithPromise(overlay);\n                Validator.validation(input)\n                    .then(function(result) {\n                        spinner.resolve();\n                        overlay.classList.add('d-none');\n                        if (result.result) {\n                            input.classList.remove('is-invalid'); // Just in case the class has been applied already.\n                            input.classList.add('is-valid');\n                            validationArea.innerText = result.message;\n                            validationArea.classList.remove('text-error');\n                            validationArea.classList.add('text-success');\n                            // Give the user some time to see their input is valid.\n                            setTimeout(function() {\n                                var loc = \"https://moodlenet.prototype.moodledemo.net/testclient.php\"\n                                    + \"?site=https%3A%2F%2Fmoodlenet.prototype.moodledemo.net\"\n                                    + \"&path=admin%2Ftool%2Fmoodlenet%2Fimport.php%3Fcourse%3D2%26section%3D0\";\n                                window.location = loc;\n                            }, 1000);\n                        } else {\n                            input.classList.add('is-invalid');\n                            validationArea.innerText = result.message;\n                            validationArea.classList.add('text-error');\n                        }\n                        return;\n                }).catch();\n            }\n        });\n    };\n\n    /**\n     * Given a user wishes to see the MoodleNet profile url form transition them there.\n     *\n     * @method chooserNavigateToMnet\n     * @param {HTMLElement} showMoodleNet The chooser's area for ment\n     * @param {Object} footerData Our footer object to render out\n     * @param {jQuery} carousel Our carousel instance to manage\n     * @param {jQuery} modal Our modal instance to manage\n     */\n    var chooserNavigateToMnet = function(showMoodleNet, footerData, carousel, modal) {\n        showMoodleNet.innerHTML = '';\n\n        // Add a spinner.\n        var spinnerPromise = LoadingIcon.addIconToContainer(showMoodleNet);\n\n        // Used later...\n        var transitionPromiseResolver = null;\n        var transitionPromise = new Promise(resolve => {\n            transitionPromiseResolver = resolve;\n        });\n\n        $.when(\n            Templates.render('tool_moodlenet/chooser_moodlenet', footerData),\n            spinnerPromise,\n            transitionPromise\n        ).then(function([html, js]) {\n                Templates.replaceNodeContents(showMoodleNet, html, js);\n                return;\n        }).catch(Notification.exception);\n\n        // We apply our handlers in here to minimise plugin dependency in the Chooser.\n        registerListenerEvents(showMoodleNet, footerData.generic);\n\n        // Move to the next slide, and resolve the transition promise when it's done.\n        carousel.one('slid.bs.carousel', function() {\n            transitionPromiseResolver();\n        });\n        // Trigger the transition between 'pages'.\n        carousel.carousel(2);\n        // eslint-disable-next-line max-len\n        modal.setFooter(Templates.render('tool_moodlenet/chooser_footer_close_mnet', {}));\n    };\n\n    /**\n     * Given a user no longer wishes to see the MoodleNet profile url form transition them from there.\n     *\n     * @method chooserNavigateFromMnet\n     * @param {jQuery} carousel Our carousel instance to manage\n     * @param {jQuery} modal Our modal instance to manage\n     * @param {Object} footerData Our footer object to render out\n     */\n    var chooserNavigateFromMnet = function(carousel, modal, footerData) {\n        // Trigger the transition between 'pages'.\n        carousel.carousel(0);\n        modal.setFooter(Templates.render(footerData.customfootertemplate, footerData));\n    };\n\n    /**\n     * Given the base footer object we need to figure out what to show the user.\n     *\n     * @method chooserFooterLogic\n     * @param {Object} data Our raw footer object\n     * @param {Number} courseId Our course ID from the chooser\n     * @param {Number} caller Our section ID from the chooser\n     * @return {Object}\n     */\n    var chooserFooterLogic = function(data, courseId, caller) {\n        // TODO: We need the information being added in MDL-68507.\n        // TODO: The link could be a part of the href where generic or advanced has returnurl & returnpath.\n        if (data.enabled === true) {\n            data.courseID = courseId;\n            data.sectionID = caller;\n        }\n        return data;\n    };\n\n    /**\n     * A small helper function for anything that wishes to add information to the footer.\n     *\n     * @param {Object} data What we use to figure out if / what we need to render\n     * @param {Number} courseId What course was this modal called from\n     * @param {Number} caller Which section of this course is this modal for\n     * @return {Object} Our data object with formatting done.\n     */\n    var footerDataBuilder = function(data, courseId, caller) {\n        // Conditionally load this based on footerData.\n        if (data.installed === true) {\n            return chooserFooterLogic(data, courseId, caller);\n        } else {\n            return data;\n        }\n    };\n\n        /**\n         * Create the custom listener that would handle anything in the footer.\n         *\n         * @param {Event} e The event being triggered.\n         * @param {Object} footerData The data generated from the exporter.\n         * @param {Object} modal The chooser modal.\n         */\n    var footerClickListener = function(e, footerData, modal) {\n        if (e.target.matches(Selectors.action.showMoodleNet) || e.target.closest(Selectors.action.showMoodleNet)) {\n            e.preventDefault();\n            const carousel = $(modal.getBody()[0].querySelector(Selectors.region.carousel));\n            const showMoodleNet = carousel.find(Selectors.region.moodleNet)[0];\n\n            chooserNavigateToMnet(showMoodleNet, footerData, carousel, modal);\n        }\n        // From the help screen go back to the module overview.\n        if (e.target.matches(Selectors.action.closeOption)) {\n            const carousel = $(modal.getBody()[0].querySelector(Selectors.region.carousel));\n\n            chooserNavigateFromMnet(carousel, modal, footerData);\n        }\n    };\n\n    return {\n        init: init,\n        chooserNavigateToMnet: chooserNavigateToMnet,\n        chooserNavigateFromMnet: chooserNavigateFromMnet,\n        chooserFooterLogic: chooserFooterLogic,\n        footerDataBuilder: footerDataBuilder,\n        footerClickListener: footerClickListener\n    };\n});\n"],"file":"instance_form.min.js"}